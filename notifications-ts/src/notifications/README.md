# Notifications Feature

This module handles the generation, processing, and delivery of notifications across different channels (In-App, Push, Email).

## Architecture

The system follows an event-driven architecture designed to decouple event detection from notification delivery.

### Workflow

1.  **Event Source**: The `worker` listens to an event stream via `event-stream.ts`.
2.  **Dispatch**: Events are routed to specific handlers (`handlers/*.ts`) based on their type (e.g., `transfer`, `post`, `member`).
3.  **Enrichment**: Handlers fetch necessary context from the API (User, Group, Member details) and create `EnrichedEvent` objects.
4.  **Distribution**: Enriched events are emitted to the `EventBus`.
5.  **Channels**: Registered channels (`app`, `push`, `email`) listen to the bus and process the events.
    - **App**: Stores notifications in the database for the user interface.
    - **Push**: Sends Web Push notifications to subscribed devices.
    - **Email**: Sends email notifications (if configured).

### Synthetic Events

Some notifications are not triggered by immediate backend events but are generated by background processes. These are handled in `synthetic/` using a job queue (BullMQ).

- **Scheduled Checks**:
    - **Transfers**: Checks for transfers still pending after a set period.
    - **Posts**: Checks for posts expiring soon.
- **Digests**: A cron job (`digest-cron.ts`) runs periodically to aggregate content and generate digest notifications (see below).

## Notification Types

The following notifications are implemented:

### Transactions
- **Transfer Sent**: Notifies the payer when a transfer is successfully committed.
- **Transfer Received**: Notifies the payee when they receive a transfer.
- **Transfer Pending**: Notifies the recipient when a transfer requires acceptance.
- **Transfer Rejected**: Notifies the sender when a pending transfer is rejected.
- **Transfer Still Pending**: Reminder for long-standing pending transfers.

### Posts (Offers/Needs)
- **New Post**: Single post notification (if not grouped into a digest).
- **Post Expires Soon**: Reminder to the author when their post is about to expire.
- **Member Expired Posts**: Summarized reminder for a member about their expired posts.

### Community
- **New Member**: Single new member notification (if not grouped into a digest).

## Digests

To avoid notification spam, the system aggregates lower-priority events into digests. The digest algorithm runs every 15 minutes and checks per-user eligibility.

- **New Posts Digest**: Aggregates new offers and needs.
- **New Members Digest**: Aggregates new members joined.

### Algorithm

The system distinguishes between a "Fast Path" and a "Slow Path" to balance timeliness with volume:

1.  **Fast Path**:
    - Trigger: **3+ new items**.
    - Silence Period: **2 days** since the last digest.
2.  **Slow Path**:
    - Trigger: **1+ new item**.
    - Silence Period: **7 days** since the last digest.

### Digest Types

There are two mutually exclusive digest types (only one is sent at a time per user, prioritizing the one waiting longest):

1.  **Posts Digest** (`PostsPublishedDigest`):
    - Aggregates new offers and needs published by existing members.
    - Filters out "urgent" posts (which send immediate notifications).

2.  **Members Digest** (`MembersJoinedDigest`):
    - Aggregates new members joined recently.
    - Includes the first posts published by these new members.

**Filtering Rules:**
- Users do not receive digests for their own content.
- Content is looked back up to **14 days**.
- Once included in a digest, items are tracked to prevent duplicate notifications.
